var AutocompleteAdapter=function(){"use strict";var Constructor=function(selector,settings){var p={};var autocomplete={};var sourceLoader=null;var defaults={sourceUrl:"/path/to/json",sourceParameter:null,sourceLoaderAsync:true,minCharacters:3,maxItems:10,titleAttribute:"title",formFieldPrefix:"region_",formFieldRestore:true,formFields:["id","country","latitude","longitude"],itemFields:["title","country"],onInit:null,onSearch:null,onSearchSuccess:null,onSearchError:null,onSearchAbort:null,onSearchBoxEvent:null,onItemSelect:null};var init=function(){autocomplete.settings=extend(true,defaults,settings);autocomplete.input=document.getElementById(selector);autocomplete.formFields={};autocomplete.results=[];autocomplete.allowSubmit=false;if(autocomplete.input===null){console.error("AutocompleteAdapter: Could not find selector",selector);return}createLoader();createSearchBox();callback(autocomplete.settings.onInit,{autocomplete:autocomplete})};var createSearchBox=function(){autocomplete.searchBox=document.createElement("div");autocomplete.searchBox.classList.add("autocomplete-search");for(var id in autocomplete.settings.formFields){var value=storage(autocomplete.settings.formFields[id]);var field=document.createElement("input");field.setAttribute("type","hidden");field.setAttribute("name",autocomplete.settings.formFieldPrefix+autocomplete.settings.formFields[id]);if(value){field.value=value}autocomplete.input.parentNode.appendChild(field);autocomplete.formFields[autocomplete.settings.formFields[id]]=field}autocomplete.input.parentNode.appendChild(autocomplete.searchBox);autocomplete.input.setAttribute("autocomplete","off");autocomplete.input.addEventListener("keyup",onSearch);autocomplete.input.addEventListener("keydown",validate);autocomplete.input.addEventListener("focus",function(e){searchbox("showOnFocus")});document.addEventListener("click",function(e){if(!getClosest(e.target,"#"+autocomplete.input.id)&&!getClosest(e.target,"."+autocomplete.searchBox.className)){searchbox("hide")}});searchbox("hide")};var createLoader=function(){autocomplete.loader=document.createElement("div");autocomplete.loader.classList.add("autocomplete-loader");autocomplete.input.parentNode.appendChild(autocomplete.loader);loader("hide")};var createItem=function(data){var item=document.createElement("div");item.classList.add("autocomplete-item");item.addEventListener("click",function(e){selectItem(data)});for(var ind in autocomplete.settings.itemFields){if(data.hasOwnProperty(autocomplete.settings.itemFields[ind])){var cont=document.createElement("span");cont.classList.add(autocomplete.settings.itemFields[ind]);cont.innerHTML=data[autocomplete.settings.itemFields[ind]];item.appendChild(cont)}}autocomplete.searchBox.appendChild(item);autocomplete.results.push([item,data])};var selectItem=function(data){for(var name in autocomplete.formFields){if(data.hasOwnProperty(name)){autocomplete.formFields[name].value=data[name]}else{autocomplete.formFields[name].value=""}storage(name,autocomplete.formFields[name].value)}if(data.hasOwnProperty(autocomplete.settings.titleAttribute)){autocomplete.input.value=data[autocomplete.settings.titleAttribute]}autocomplete.input.dispatchEvent(new Event("change"));searchbox("hide");callback(autocomplete.settings.onItemSelect,{autocomplete:autocomplete})};var onSearch=function(e){autocomplete.allowSubmit=false;var val=autocomplete.input.value.trim();if([37,38,39,40,36,35,33,34].indexOf(e.keyCode)>-1){return}if(sourceLoader!==null){sourceLoader.abort();callback(autocomplete.settings.onSearchAbort,{xhr:sourceLoader,autocomplete:autocomplete})}if(val&&val.length>=autocomplete.settings.minCharacters){doSearch(extend(true,autocomplete.settings.sourceParameter||{},{search:val}))}else{searchbox("clear")}};var doSearch=function(param){if(callback(autocomplete.settings.onSearch,{param:param,autocomplete:autocomplete})){return}loader("show");var url=autocomplete.settings.sourceUrl;if(typeof param==="object"){url+="?"+serialize(param)}sourceLoader=new XMLHttpRequest;sourceLoader.open("GET",url,autocomplete.settings.sourceLoaderAsync);sourceLoader.onload=function(){if(sourceLoader.status>=200&&sourceLoader.status<400){var results=JSON.parse(sourceLoader.responseText);searchbox("clear");loader("hide");if(results.error.status<1&&results.data){var i=0;for(var id in results.data){createItem(results.data[id]);if(i++>=autocomplete.settings.maxItems){break}}searchbox("show")}sourceLoader=null;callback(autocomplete.settings.onSearchSuccess,{results:results,autocomplete:autocomplete})}};sourceLoader.onerror=function(){searchbox("clear");callback(autocomplete.settings.onSearchError,{autocomplete:autocomplete})};sourceLoader.send()};var validate=function(e){autocomplete.input.form.addEventListener("submit",preventFormSubmit,false);if([13,9].indexOf(e.keyCode)>-1&&!autocomplete.allowSubmit&&autocomplete.results.length>=1){selectItem(autocomplete.results[0][1]);autocomplete.allowSubmit=true}autocomplete.input.form.removeEventListener("submit",preventFormSubmit);if(e.keyCode===13&&autocomplete.allowSubmit){autocomplete.input.form.submit()}};var preventFormSubmit=function(){return false};var searchbox=function(mode){switch(mode){case"clear":autocomplete.results=[];autocomplete.searchBox.innerHTML="";for(var name in autocomplete.formFields){autocomplete.formFields[name].value=""}case"hide":autocomplete.searchBox.style.display="none";break;case"showOnFocus":if(!autocomplete.results.length)break;case"show":autocomplete.searchBox.style.display="block";break}callback(autocomplete.settings.onSearchBoxEvent,{mode:mode,autocomplete:autocomplete})};var loader=function(mode){switch(mode){case"hide":autocomplete.loader.style.display="none";break;case"show":autocomplete.loader.style.display="block";break}};var storage=function(variable,value){if(autocomplete.settings.formFieldRestore&&typeof value!=="undefined"){return sessionStorage.setItem(variable,value)}else if(autocomplete.settings.formFieldRestore){return sessionStorage.getItem(variable)}return null};var callback=function(func,param){if(typeof func==="function"){func.call(this,param);return true}return false};var getClosest=function(elem,selector){var firstChar=selector.charAt(0);var supports="classList"in document.documentElement;var attribute,value;if(firstChar==="["){selector=selector.substr(1,selector.length-2);attribute=selector.split("=");if(attribute.length>1){value=true;attribute[1]=attribute[1].replace(/"/g,"").replace(/'/g,"")}}for(;elem&&elem!==document;elem=elem.parentNode){if(firstChar==="."){if(supports){if(elem.classList.contains(selector.substr(1))){return elem}}else{if(new RegExp("(^|\\s)"+selector.substr(1)+"(\\s|$)").test(elem.className)){return elem}}}if(firstChar==="#"){if(elem.id===selector.substr(1)){return elem}}if(firstChar==="["){if(elem.hasAttribute(attribute[0])){if(value){if(elem.getAttribute(attribute[0])===attribute[1]){return elem}}else{return elem}}}if(elem.tagName.toLowerCase()===selector){return elem}}return null};var serialize=function(obj,prefix){var str=[],p;for(p in obj){if(obj.hasOwnProperty(p)){var k=prefix?prefix+"["+p+"]":p,v=obj[p];str.push(v!==null&&typeof v==="object"?serialize(v,k):encodeURIComponent(k)+"="+encodeURIComponent(v))}}return str.join("&")};var extend=function(){var extended={};var deep=false;var i=0;var length=arguments.length;if(Object.prototype.toString.call(arguments[0])==="[object Boolean]"){deep=arguments[0];i++}var merge=function(obj){for(var prop in obj){if(Object.prototype.hasOwnProperty.call(obj,prop)){if(deep&&Object.prototype.toString.call(obj[prop])==="[object Object]"){extended[prop]=extend(true,extended[prop],obj[prop])}else{extended[prop]=obj[prop]}}}};for(;i<length;i++){var obj=arguments[i];merge(obj)}return extended};p.getAutocomplete=function(){return autocomplete};p.searchbox=function(mode){searchbox(mode)};p.loader=function(mode){loader(mode)};p.createItem=function(data){createItem(data)};init();return p};return Constructor}();